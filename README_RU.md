# Цифровой Аватар

Интерактивная система 3D-аватара с голосовым взаимодействием, эмоциональными выражениями и поддержкой WebRTC. Построена на современном open-source стеке.

## Возможности

- **3D-Аватар**: Рендеринг GLB-моделей с Three.js
- **Голосовое взаимодействие**: Речь в текст (Web Speech API) и текст в речь (Coqui TTS)
- **ИИ-бэкенд**: Open-source LLM (Llama 3) через Ollama
- **Синхронизация губ**: Реализация lip-sync с анализом аудио
- **Эмоции и жесты**: Динамические выражения лица и эмоциональные реакции
- **Поддержка WebRTC**: Функционал видеозвонков с трансляцией аватара
- **История чата**: Постоянное хранение диалогов
- **Мобильная версия**: Адаптивный дизайн для мобильных устройств

## Архитектура

```
digital_avatar/
├── docker-compose.yml          # Настройка многоконтейнерной среды
├── assets/                     # 3D-модели и статические ресурсы
├── avatar-server/              # Основное приложение (FastAPI + Frontend)
├── tts-server/                 # TTS-сервис (Flask + Coqui TTS)
└── data/                       # База данных и постоянное хранилище
```

## Предварительные требования

- Docker и Docker Compose
- NVIDIA GPU (рекомендуется для производительности TTS)
- Современный браузер с поддержкой WebGL и WebRTC

## Быстрый старт

1. **Клонирование и установка**:
```bash
git clone <your-repo>
cd digital_avatar
```

2. **Загрузка модели LLM**:
```bash
docker compose up ollama -d
docker exec -it ollama ollama pull llama3
```

3. **Запуск всех сервисов**:
```bash
docker compose up --build
```

4. **Откройте браузер**:
Перейдите по адресу `http://localhost:8000`

## Конфигурация

### Переменные окружения

**Сервер аватара**:
- `OLLAMA_URL`: Эндпоинт сервиса Ollama (по умолчанию: http://ollama:11434)
- `TTS_URL`: Эндпоинт TTS-сервиса (по умолчанию: http://tts-server:5002)
- `DB_PATH`: Путь к базе данных чата (по умолчанию: /data/chat.db)

**TTS-сервер**:
- `TTS_MODEL`: Название TTS-модели (по умолчанию: tts_models/multilingual/multi-dataset/your_tts)

### Подготовка модели

1. Разместите вашу 3D-модель аватара в `assets/avatar.glb`
2. Убедитесь, что модель содержит следующие morph targets:
   - mouthOpen
   - Blink_Left
   - Blink_Right
   - Smile

## API endpoints

- `POST /api/chat` - Основной endpoint чата
- `WS /ws/{room_id}` - WebRTC signaling
- `GET /audio/{filename}` - Сгенерированные аудиофайлы
- `POST /tts` - Генерация речи

## Разработка

### Структура фронтенда
```
frontend/
├── main.js                 # Входная точка приложения
├── modules/
│   ├── scene.js           # Управление сценой Three.js
│   ├── avatar.js          # Управление аватаром и анимации
│   ├── audio.js           # Обработка аудио и lip-sync
│   ├── ui.js              # Элементы управления интерфейсом
│   └── utils.js           # Вспомогательные функции
```

### Добавление новых функций

1. **Новые эмоции**:
   - Добавьте morph targets в 3D-модель
   - Расширьте метод `AvatarController.reactEmoji()`
   - Добавьте элементы управления в `ui.js`

2. **Пользовательские анимации**:
   - Добавьте анимационные клипы в GLB-модель
   - Управляйте через `mixer.clipAction()` в `scene.js`

## Решение проблем

### Частые проблемы

1. **Аватар не загружается**:
   - Проверьте консоль браузера на ошибки загрузки GLB
   - Убедитесь в правильности пути к модели и настройках CORS

2. **TTS не работает**:
   - Проверьте, что TTS-модель загружена правильно
   - Убедитесь в правах доступа к файлам в tts-cache

3. **Ошибка подключения к Ollama**:
   - Убедитесь, что контейнер Ollama запущен
   - Проверьте завершение загрузки модели

### Советы по производительности

- Уменьшите разрешение текстур для мобильных устройств
- Уменьшите полигональную сетку 3D-модели
- Включите GPU-ускорение в Docker (NVIDIA runtime)

## Лицензия

Открытая лицензия MIT. Подробности в файле LICENSE.

## Участие в разработке

1. Сделайте форк репозитория
2. Создайте ветку для функции (`git checkout -b feature/amazing-feature`)
3. Зафиксируйте изменения (`git commit -m 'Add amazing feature'`)
4. Запушьте в ветку (`git push origin feature/amazing-feature`)
5. Откройте Pull Request